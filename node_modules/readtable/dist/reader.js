'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setCurrentReadtable = setCurrentReadtable;
exports.getCurrentReadtable = getCurrentReadtable;

var _charStream = require('./char-stream');

var _readtable = require('./readtable');

const defaultDispatchKey = '#';
let dispatching = false;

let currentReadtable = _readtable.EmptyReadtable.extend({
  key: defaultDispatchKey,
  mode: 'non-terminating',
  action: function readDispatchChar(stream, ...rest) {
    stream.readString();
    dispatching = true;
    return this.read(stream, ...rest, defaultDispatchKey);
  }
});

class Reader {
  read(stream, ...rest) {
    let key = stream.peek();
    if (!(0, _charStream.isEOS)(key)) {
      const entry = currentReadtable.getMapping(key);
      const action = dispatching ? (dispatching = false, entry.dispatchAction) : entry.action;

      return action.call(this, stream, ...rest);
    }
    throw Error('Unexpected end of input');
  }
}

exports.default = Reader;
function setCurrentReadtable(readtable) {
  currentReadtable = readtable;
}

function getCurrentReadtable() {
  return currentReadtable;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZWFkZXIuanMiXSwibmFtZXMiOlsic2V0Q3VycmVudFJlYWR0YWJsZSIsImdldEN1cnJlbnRSZWFkdGFibGUiLCJkZWZhdWx0RGlzcGF0Y2hLZXkiLCJkaXNwYXRjaGluZyIsImN1cnJlbnRSZWFkdGFibGUiLCJleHRlbmQiLCJrZXkiLCJtb2RlIiwiYWN0aW9uIiwicmVhZERpc3BhdGNoQ2hhciIsInN0cmVhbSIsInJlc3QiLCJyZWFkU3RyaW5nIiwicmVhZCIsIlJlYWRlciIsInBlZWsiLCJlbnRyeSIsImdldE1hcHBpbmciLCJkaXNwYXRjaEFjdGlvbiIsImNhbGwiLCJFcnJvciIsInJlYWR0YWJsZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7UUFrQ2dCQSxtQixHQUFBQSxtQjtRQUlBQyxtQixHQUFBQSxtQjs7QUFqQ2hCOztBQUNBOztBQUVBLE1BQU1DLHFCQUFxQixHQUEzQjtBQUNBLElBQUlDLGNBQWMsS0FBbEI7O0FBRUEsSUFBSUMsbUJBQW1CLDBCQUFlQyxNQUFmLENBQXNCO0FBQzNDQyxPQUFLSixrQkFEc0M7QUFFM0NLLFFBQU0saUJBRnFDO0FBRzNDQyxVQUFRLFNBQVNDLGdCQUFULENBQTBCQyxNQUExQixFQUFrQyxHQUFHQyxJQUFyQyxFQUEyQztBQUNqREQsV0FBT0UsVUFBUDtBQUNBVCxrQkFBYyxJQUFkO0FBQ0EsV0FBTyxLQUFLVSxJQUFMLENBQVVILE1BQVYsRUFBa0IsR0FBR0MsSUFBckIsRUFBMkJULGtCQUEzQixDQUFQO0FBQ0Q7QUFQMEMsQ0FBdEIsQ0FBdkI7O0FBVWUsTUFBTVksTUFBTixDQUFhO0FBQzFCRCxPQUFLSCxNQUFMLEVBQXlCLEdBQUdDLElBQTVCLEVBQW9EO0FBQ2xELFFBQUlMLE1BQU1JLE9BQU9LLElBQVAsRUFBVjtBQUNBLFFBQUksQ0FBQyx1QkFBTVQsR0FBTixDQUFMLEVBQWlCO0FBQ2YsWUFBTVUsUUFBUVosaUJBQWlCYSxVQUFqQixDQUE0QlgsR0FBNUIsQ0FBZDtBQUNBLFlBQU1FLFNBQVNMLGVBQWVBLGNBQWMsS0FBZCxFQUFxQmEsTUFBTUUsY0FBMUMsSUFBNERGLE1BQU1SLE1BQWpGOztBQUVBLGFBQU9BLE9BQU9XLElBQVAsQ0FBWSxJQUFaLEVBQWtCVCxNQUFsQixFQUEwQixHQUFHQyxJQUE3QixDQUFQO0FBQ0Q7QUFDRCxVQUFNUyxNQUFNLHlCQUFOLENBQU47QUFDRDtBQVZ5Qjs7a0JBQVBOLE07QUFhZCxTQUFTZCxtQkFBVCxDQUE2QnFCLFNBQTdCLEVBQXlEO0FBQzlEakIscUJBQW1CaUIsU0FBbkI7QUFDRDs7QUFFTSxTQUFTcEIsbUJBQVQsR0FBMEM7QUFDL0MsU0FBT0csZ0JBQVA7QUFDRCIsImZpbGUiOiJyZWFkZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgdHlwZSBSZWFkdGFibGUgZnJvbSAnLi9yZWFkdGFibGUnO1xuaW1wb3J0IHR5cGUgQ2hhclN0cmVhbSBmcm9tICcuL2NoYXItc3RyZWFtJztcblxuaW1wb3J0IHsgaXNFT1MgfSBmcm9tICcuL2NoYXItc3RyZWFtJztcbmltcG9ydCB7IEVtcHR5UmVhZHRhYmxlIH0gZnJvbSAnLi9yZWFkdGFibGUnO1xuXG5jb25zdCBkZWZhdWx0RGlzcGF0Y2hLZXkgPSAnIyc7XG5sZXQgZGlzcGF0Y2hpbmcgPSBmYWxzZTtcblxubGV0IGN1cnJlbnRSZWFkdGFibGUgPSBFbXB0eVJlYWR0YWJsZS5leHRlbmQoe1xuICBrZXk6IGRlZmF1bHREaXNwYXRjaEtleSxcbiAgbW9kZTogJ25vbi10ZXJtaW5hdGluZycsXG4gIGFjdGlvbjogZnVuY3Rpb24gcmVhZERpc3BhdGNoQ2hhcihzdHJlYW0sIC4uLnJlc3QpIHtcbiAgICBzdHJlYW0ucmVhZFN0cmluZygpO1xuICAgIGRpc3BhdGNoaW5nID0gdHJ1ZTtcbiAgICByZXR1cm4gdGhpcy5yZWFkKHN0cmVhbSwgLi4ucmVzdCwgZGVmYXVsdERpc3BhdGNoS2V5KTtcbiAgfVxufSk7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJlYWRlciB7XG4gIHJlYWQoc3RyZWFtOiBDaGFyU3RyZWFtLCAuLi5yZXN0PzogQXJyYXk8YW55Pik6IGFueSB7XG4gICAgbGV0IGtleSA9IHN0cmVhbS5wZWVrKCk7XG4gICAgaWYgKCFpc0VPUyhrZXkpKSB7XG4gICAgICBjb25zdCBlbnRyeSA9IGN1cnJlbnRSZWFkdGFibGUuZ2V0TWFwcGluZyhrZXkpO1xuICAgICAgY29uc3QgYWN0aW9uID0gZGlzcGF0Y2hpbmcgPyAoZGlzcGF0Y2hpbmcgPSBmYWxzZSwgZW50cnkuZGlzcGF0Y2hBY3Rpb24pIDogZW50cnkuYWN0aW9uO1xuXG4gICAgICByZXR1cm4gYWN0aW9uLmNhbGwodGhpcywgc3RyZWFtLCAuLi5yZXN0KTtcbiAgICB9XG4gICAgdGhyb3cgRXJyb3IoJ1VuZXhwZWN0ZWQgZW5kIG9mIGlucHV0Jyk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNldEN1cnJlbnRSZWFkdGFibGUocmVhZHRhYmxlOiBSZWFkdGFibGUpOiB2b2lkIHtcbiAgY3VycmVudFJlYWR0YWJsZSA9IHJlYWR0YWJsZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEN1cnJlbnRSZWFkdGFibGUoKTogUmVhZHRhYmxlIHtcbiAgcmV0dXJuIGN1cnJlbnRSZWFkdGFibGU7XG59XG4iXX0=